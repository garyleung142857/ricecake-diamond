---
const { stem } = Astro.props;
import {h} from 'hastscript'
import { visit, CONTINUE } from 'unist-util-visit'
import { rehype } from 'rehype'

const bodyHtml = await Astro.slots.render('default')
const breakCalls = () => (tree: any) => {
    visit(tree, 'element', (node: any) => {
        if(node.tagName === 'p') {
            if (node.properties.class == undefined) {
                node.properties.class = ['tree-stem']
            } else {
                node.properties.class.push('tree-stem')
            }
            return CONTINUE
        }
        node.children = node.children.filter(
            (child) => !/^\n+$/.test(child.value)
        )
        if (node.tagName !== 'li') return CONTINUE
        
        const colonIndex = node.children.findIndex(c => c.value?.indexOf(':') > -1)
        if (colonIndex === -1) return CONTINUE
        let texts = node.children[colonIndex].value.split(':', 2)
        let newChildren = [
            h('span.tree-call', node.children.slice(0, colonIndex).concat(h('text', texts[0]))),
            h('text', texts[1].trimStart()),
            ...node.children.slice(colonIndex + 1)
        ]
        
        node.children = newChildren
    })
}


const processedHtml = await rehype()
    .use(breakCalls)
    .process(bodyHtml)

---
<div class="bidding-tree">
    <Fragment set:html={processedHtml} />
</div>

<style>
.bidding-tree {
    padding: 10px;
    ul {
        margin-top: 0 !important;
        list-style-type: none;
        padding-left: 3em;
    }
    > ul {
        padding-left: 0.5em;
    }
    
    li {
        margin-top: 0 !important;
        line-height: 150%;
    }

    .tree-stem {
        font-weight: bold;
        border-bottom: solid 2px rgb(50, 50, 132);
        margin-bottom: 5px;
    }
    .tree-call {
        display: inline-block;
        min-width: 3em;
        padding-right: 0.5em;
    }
}
</style>